<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Agent</title>
    <!-- Tailwind CSS (via CDN for simplicity) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .markdown-body pre { background-color: #1e1e1e; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
        .markdown-body code { background-color: rgba(175, 184, 193, 0.2); padding: 0.2em 0.4em; border-radius: 6px; font-family: monospace; }
        .markdown-body pre code { background-color: transparent; padding: 0; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body h2 { font-size: 1.25em; font-weight: bold; margin-top: 0.8em; margin-bottom: 0.4em; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center space-x-3">
            <!-- Updated Icon: "D" for Desktop Agent -->
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white">D</div>
            <h1 class="text-lg font-semibold text-white">Desktop Agent</h1>
        </div>
        <div class="text-xs text-gray-400"></div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
        <!-- Messages will be injected here -->
        <div class="flex justify-start">
            <div class="bg-gray-800 rounded-2xl rounded-tl-none px-4 py-3 max-w-[80%] shadow-sm">
                <div class="markdown-body text-sm text-gray-200">
                    <b> <i>Hello! I am your AI Desktop Agent. How can I help you today?</i></b>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="bg-gray-800 border-t border-gray-700 p-4">
        <div class="max-w-4xl mx-auto relative flex items-end bg-gray-700 rounded-xl border border-gray-600 focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500 transition-all">
            <textarea id="message-input" rows="1" 
                class="w-full bg-transparent text-white placeholder-gray-400 px-4 py-3 focus:outline-none resize-none max-h-32"
                placeholder="Type a message... (Shift+Enter for new line)"
                oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 128) + 'px'"></textarea>
            <button id="send-btn" class="mb-2 mr-2 p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
        <div class="text-center text-xs text-gray-500 mt-2">
            Press Enter to send, Shift+Enter for new line
        </div>
    </footer>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        
        let currentAgentMessageDiv = null;
        let currentAgentContent = "";
        let currentReasoningDiv = null;
        let currentReasoningContent = "";
        let thinkingDiv = null;

        // Markdown config
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Expose function to Go: Show thinking indicator
        window.showThinking = function() {
            if (thinkingDiv) return; // Already thinking

            const div = document.createElement('div');
            div.className = 'flex justify-start';
            
            const bubble = document.createElement('div');
            bubble.className = 'bg-gray-800 text-gray-200 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm flex items-center';
            
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            
            bubble.appendChild(indicator);
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            thinkingDiv = div;
            scrollToBottom();
        }

        function removeThinking() {
             if (thinkingDiv) {
                 chatContainer.removeChild(thinkingDiv);
                 thinkingDiv = null;
             }
        }

        function ensureAgentMessage() {
            if (!currentAgentMessageDiv) {
                 window.appendMessage('agent', '');
            }
        }

        // Expose function to Go: Append message
        // role: 'user' or 'agent'
        window.appendMessage = function(role, content) {
            removeThinking();

            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user' 
                ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none px-4 py-3 max-w-[80%] shadow-sm'
                : 'bg-gray-800 text-gray-200 rounded-2xl rounded-tl-none px-4 py-3 max-w-[80%] shadow-sm';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'markdown-body text-sm';
            
            if (role === 'agent') {
                contentDiv.innerHTML = marked.parse(content);
                currentAgentMessageDiv = contentDiv; // Track for streaming
                currentAgentContent = content;
                currentReasoningDiv = null; // Reset reasoning context for new message
                currentReasoningContent = "";
            } else {
                contentDiv.textContent = content; // User input is raw text
            }
            
            bubble.appendChild(contentDiv);
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // Expose function to Go: Append reasoning token
        window.appendReasoning = function(token) {
            removeThinking();
            
            // If we don't have a reasoning block yet, create one INSIDE the current agent bubble or a new one?
            // Usually reasoning comes BEFORE the answer.
            // If currentAgentMessageDiv exists and has content, it might be weird.
            // Let's assume reasoning starts first.
            
            if (!currentReasoningDiv) {
                // Create a new bubble just for reasoning, or append to the last agent bubble?
                // Let's create a new "Thinking Process" block.
                
                const div = document.createElement('div');
                div.className = 'flex justify-start mb-2';
                
                const details = document.createElement('details');
                details.className = 'bg-gray-800 text-gray-400 rounded-lg px-4 py-2 text-xs w-full max-w-[80%] border border-gray-700';
                details.open = true; // Open by default while generating
                
                const summary = document.createElement('summary');
                summary.className = 'cursor-pointer font-bold mb-2 select-none';
                summary.innerText = 'ÊÄùËÄÉ‰∏≠...';
                
                const content = document.createElement('div');
                content.className = 'whitespace-pre-wrap font-mono';
                
                details.appendChild(summary);
                details.appendChild(content);
                div.appendChild(details);
                
                chatContainer.appendChild(div);
                currentReasoningDiv = content;
                scrollToBottom();
            }
            
            currentReasoningContent += token;
            currentReasoningDiv.innerText = currentReasoningContent;
            scrollToBottom();
        }

        // Expose function to Go: Append tool call
        window.appendToolCall = function(name, args) {
            removeThinking();

            const div = document.createElement('div');
            div.className = 'flex justify-start mb-2';
            
            const badge = document.createElement('div');
            badge.className = 'bg-gray-700 text-blue-300 rounded px-3 py-1 text-xs font-mono border border-gray-600 flex items-center gap-2';
            badge.innerHTML = `<span>üîß</span> <span>Using Tool: <b>${name}</b></span>`;
            // We can optionally show args in a tooltip or collapsed
            
            div.appendChild(badge);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // Expose function to Go: Append token (streaming)
        window.appendToken = function(token) {
            removeThinking();
            
            // If reasoning block was present, remove it when we start receiving the actual answer
            if (currentReasoningDiv) {
                // Remove the entire block (div -> details -> content)
                const details = currentReasoningDiv.parentElement;
                if (details) {
                    const container = details.parentElement;
                    if (container && container.parentNode === chatContainer) {
                        chatContainer.removeChild(container);
                    }
                }
                currentReasoningDiv = null; // Stop tracking reasoning
            }

            if (!currentAgentMessageDiv) {
                // If no current message, create a new one (using appendMessage to handle setup)
                window.appendMessage('agent', '');
            }
            
            currentAgentContent += token;
            currentAgentMessageDiv.innerHTML = marked.parse(currentAgentContent);
            scrollToBottom();
        }

        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;

            // Optimistic UI update
            window.appendMessage('user', content);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Reset current agent message tracker so next token creates new bubble
            currentAgentMessageDiv = null;
            currentAgentContent = "";
            currentReasoningDiv = null;

            // Call Go function
            if (window.sendMessageToAgent) {
                window.sendMessageToAgent(content);
            } else {
                console.error("Backend not connected");
                // Mock for testing without backend
                setTimeout(() => {
                    window.appendToken("Echo: " + content);
                }, 500);
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize syntax highlighting
        hljs.highlightAll();
    </script>
</body>
</html>
